FROM node:22-bookworm

WORKDIR /app

# Install system dependencies required for Postgres & curl (used for readiness checks)
RUN apt-get update \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    gnupg \
    postgresql \
    postgresql-contrib \
  && rm -rf /var/lib/apt/lists/*

# Copy package manifests (and Prisma schema, needed for postinstall) up front to leverage Docker layer caching
COPY package*.json ./
COPY prisma ./prisma
COPY .env.template ./.env.template
# Use npm install instead of npm ci to get correct platform-specific optional deps (e.g., rollup Linux bindings)
RUN npm install --ignore-scripts && npm rebuild && npm rebuild argon2 --build-from-source

# Copy the rest of the application code (excluding secrets via .dockerignore)
COPY . .

# Create container-specific .env seeded from template if present
RUN if [ -f ".env.template" ] && [ ! -f ".env" ]; then cp .env.template .env; fi

# Ensure the integration entrypoint is executable
RUN chmod +x /app/docker/integration-entrypoint.sh

ENV NODE_ENV=test \
    NEXT_TELEMETRY_DISABLED=1 \
    DB_USER=postgres \
    DB_PASSWORD=postgres \
    DB_NAME=ladderly_io_test \
    DB_PORT=5432 \
    APP_HOST=0.0.0.0 \
    APP_PORT=3000

EXPOSE 3000

ENTRYPOINT ["/app/docker/integration-entrypoint.sh"]

